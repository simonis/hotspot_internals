<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta charset="utf-8" />

    <title>HotSpot Internals: Signals, Safepoints and NullPointers</title>

    <meta name="description" content="A deep dive into various HotSpot implemantation details" />
    <meta name="author" content="Volker H. Simonis" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />

    <link rel="stylesheet" href="reveal.js/css/reveal.css" />
    <link rel="stylesheet" href="reveal.js/css/theme/jbreak2016.css" id="theme" />

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="reveal.js/lib/css/monokai_sublime.css" />

  <style type="text/css">
.scrollable {
    bottom: 0px;
    overflow-y: auto  !important;
    overflow-x: hidden !important;
}

.reveal .slides > section.demo,
.reveal .slides > section > section.demo {
    padding: 0;
    height: 100%;
}

.reveal .big {
    font-size: .8em;
    line-height: 1.3em;
}

.reveal pre.console {
    background-color: black;
    color: #00ff00;
}

code.terminal .hljs-title {
    color: #00ff00;
}

.reveal pre.noshadow {
    border-radius: 0;
    box-shadow: unset;
}

.reveal pre code {
    max-height: 100%;
}
.bold {
    font-weight: bold;
}

.reveal .outline_white {
    color: white;
    text-shadow:
        -2px -2px 0 #000,
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000;
    min-height: 1.1em;
    text-align: center;
}
.reveal .outline_black {
    color: black;
    text-shadow:
        -2px -2px 0 #fff,
         2px -2px 0 #fff,
        -2px  2px 0 #fff,
         2px  2px 0 #fff;
    min-height: 1.1em;
    text-align: center;
}

.reveal .slide-number {
    position: fixed;
    display: block;
    left: 15px;
    bottom: 15px;
    opacity: 0.9;
    z-index: 31;
    font-size: 14px;
}
.reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
    text-transform: none;
}

.hljs-class .hljs-title {
    /* fix "public static class Y extends X {" such that 'Y' will be formatted the same like 'X' */
    color: #A6E22E;
    font-style: italic;
}

mark {
    color: black;
    background-color: yellow;
    border-radius: 10px;
}
mark.orange {
    color: black;
    background-color: orange;
    border-radius: 10px;
}
mark.border {
    color: inherit;
    background-color: inherit;
    border: 5px solid #1B91FF;
    border-radius: 10px;
}
mark.border-no-top {
    color: inherit;
    background-color: inherit;
    border: 5px solid #1B91FF;
    border-width: 0px 5px 5px 5px;
    border-radius: 0px 0px 10px 10px;
}
mark.border-no-bottom {
    color: inherit;
    background-color: inherit;
    border: 5px solid #1B91FF;
    border-width: 5px 5px 0px 5px;
    border-radius: 10px 10px 0px 0px;
}

.reveal .slides section .fragment.highlight-border, .reveal .slides section .fragment.highlight-current-border {
  opacity: 1;
  visibility: visible;
}
.reveal .slides section .fragment.highlight-border.visible {
  border: 5px solid #1B91FF;
  border-radius: 10px;
}
.reveal .slides section .fragment.highlight-current-border.current-fragment {
  border: 5px solid #1B91FF;
  border-radius: 10px;
}
  </style>

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->

    <!--
      Issue #1105: Keyboard shortcut to skip forward/back over fragments #1173
      https://github.com/hakimel/reveal.js/pull/1173
    -->
  </head>

<!--
;; select this code and do 'M-x eval-region'
(defun make-fragment (p1 p2)
  "Wraps the selection into 'fragment' <span>s and replaces '&', '<' and '>' with html entities."
  (interactive "r")
  (setq inputStr (buffer-substring-no-properties p1 p2))
  (setq inputStr (replace-regexp-in-string "&" "&amp;" inputStr))
  (setq inputStr (replace-regexp-in-string "<" "&lt;" inputStr))
  (setq inputStr (replace-regexp-in-string ">" "&gt;" inputStr))
  (setq resultStr (concat "<span class=\"fragment\">" (concat inputStr "</span>")))
  (delete-region p1 p2)
  (insert resultStr)
)
(defun make-fragment-simple (p1 p2)
  "Wraps the selection into 'fragment' <span>s."
  (interactive "r")
  (setq inputStr (buffer-substring-no-properties p1 p2))
  (setq resultStr (concat "<span class=\"fragment\">" (concat inputStr "</span>")))
  (delete-region p1 p2)
  (insert resultStr)
)

(global-set-key (kbd "C-f") 'make-fragment)
(global-set-key (kbd "C-S-f") 'make-fragment-simple)
;; revert key-binding
;; (global-set-key (kbd "C-f") 'forward-char)
;;
;; use 'C-h k <keystroke>' to find out what <keystroke> ia currently bound to

;; (vhs) The following is required to make 'C-c C-t' insert <code> tags without
;; newlines. 'sgml-tag-alist' is the "file-local" version of 'html-tag-alist'
(add-to-list 'html-tag-alist '("code"))
(add-to-list 'sgml-tag-alist '("code"))

-->

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section style="height:100%" data-background="images/gearbox.jpg">
          <div style="height:10%"></div>
          <div style="height:50%">
            <h1 class="outline_white">HotSpot Internals -<br/>Signals, Safepoints and NullPointers<br/></h1>
            <p>
              <span class="outline_white">Volker Simonis [Фолькер Симонис], SAP /
                <a href="mailto:volker.simonis@gmail.com" class="outline_white">volker.simonis@gmail.com</a></span>
            </p>
          </div>
          <div style="height:35%"></div>
          <div style="height:5%">
            <p><small><a href="http://www.sunstategearbox.com.au/wp-content/uploads/2014/09/gearbox.jpg">
                  http://www.sunstategearbox.com.au/wp-content/uploads/2014/09/gearbox.jpg</a></small>
            </p>
          </div>
        </section>

<!--

  ImplicitNullCheckThreshold, 3,                              \
          "Don't do implicit null checks if NPE's in a method exceeds "     \
          "limit
  diagnostic_pd(bool, ImplicitNullChecks,                                   \
          "Generate code for implicit null checks")                         \

  MacroAssembler::needs_explicit_null_check() in assembler.cpp

/share/software/Java/jdk1.8.0_66/jre/bin/java

Benchmark                 Mode  Cnt  Score   Error  Units
NullCheck.getField_1      avgt    5  5.309 ± 0.245  ns/op
NullCheck.getField_2      avgt    5  5.902 ± 0.236  ns/op
NullCheck.getNullField_1  avgt    5  3.784 ± 0.203  ns/op
NullCheck.getNullField_2  avgt    5  3.789 ± 0.171  ns/op
Benchmark                 Mode  Cnt  Score   Error  Units
NullCheck.getField_1      avgt    5  5.211 ± 0.222  ns/op
NullCheck.getField_2      avgt    5  5.950 ± 0.344  ns/op
NullCheck.getNullField_1  avgt    5  3.813 ± 0.313  ns/op
NullCheck.getNullField_2  avgt    5  3.758 ± 0.231  ns/op

CPU with a clock rate of 3 GHz (three billion cycles per second corresponding to ~3.3×10−10seconds or 0.33 nanoseconds per cycle

-->

        <section>

          <h3 style="text-transform: none;"><a href="https://github.com/simonis/hotspot_internals">https://github.com/simonis/hotspot_internals</a></h3>

          <h3 style="text-transform: none;"><a href="https://rawgit.com/simonis/hotspot_internals/master/hotspot_internals.xhtml#/">https://rawgit.com/simonis/hotspot_internals/master/hotspot_internals.xhtml</a></h3>

        </section>

        <section>
          <section>
            <h2>HotSpot VM Overview</h2>

            <div width="100%" style="position: relative; margin: 0 0 0 0px;">
              <div class="" style="position: static;">
                <object data="images/adjusted/VM_Overview.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="1" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/CodeCache.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
            </div>
          </section>

          <section>
            <h2>Dynamic Code Generation</h2>

            <pre class="big noshadow" data-trim="true">
              <code class="cpp" data-trim="true" data-noescape="true">
class Assembler : public AbstractAssembler  {
  // Creation
  Assembler(<span class="fragment highlight-border" data-fragment-index="1">CodeBuffer* code</span>) : AbstractAssembler(code) {...}
  // Vanilla instructions in lexical order
  void call(Label&amp; L, relocInfo::relocType rtype);
  void call(Register reg);  // push pc; pc &lt;- reg
  ...
  void <span class="fragment highlight-border" data-fragment-index="2">imulq</span>(Register dst, Register src);
};

void <span class="fragment highlight-border" data-fragment-index="2">Assembler::imulq</span>(Register dst, Register src) {
  int encode = prefixq_and_encode(dst->encoding(), src->encoding());
  <span class="fragment highlight-border" data-fragment-index="3">emit_int8</span>(0x0F);
  emit_int8((unsigned char)0xAF);
  emit_int8((unsigned char)(0xC0 | encode));
}
              </code>
            </pre>
          </section>

          <section>
            <h2>Dynamic Code Generation</h2>
            <pre class="big noshadow" data-trim="true">
              <code class="cpp" data-trim="true" data-noescape="true">
class MacroAssembler: public Assembler {...};
class InterpreterMacroAssembler: public MacroAssembler {...};

// The TemplateTable generates assembler templates for each bytecode.
class TemplateTable {
  // The assembler used when generating the bytecode templates.
  <span class="fragment highlight-border">static InterpreterMacroAssembler* _masm;</span>
  ...
};

<span class="fragment highlight-border">#define __ _masm-&gt;</span>

void TemplateTable::lmul() {
  __ pop_l(rdx);
  <span class="fragment highlight-border">__ imulq(rax, rdx);</span>
}
              </code>
            </pre>
          </section>
        </section>


        <section style="height: 100%;">
          <section>

            <h2>Signals</h2>

            <ul>
              <li>Asynchronous notifications sent to a process/thread</li>
              <li>Originate from 1970s Bell Labs Unix - now POSIX</li>
              <li>Quite heavy-weight operations</li>
              <li>Interferes with new features like C++ exceptions &amp; threads</li>
              <li>Nevertheless reliable, cross-platform (POSIX), useful..</li>
              <li>On Windows there's a similar mechanism called<br/>Structured/Vectored Exception Handling (SEH/VEH)</li>
            </ul>
          </section>

          <section>

            <h2>Signals</h2>

            <ul>
              <li>Many programmers are scared by signals</li>
              <li>Ever saw <code>SIGSEGV</code>, <code>SIGILL</code>, <code>SIGBUS</code>,.. ?</li>
              <li>They are usually associated with crashes and core files</li>
              <li>But they can be useful :-)</li>
            </ul>
<!--
            <br/>
            <p><span style="font-size:500%">DEMO<br/></span>
            <span style="font-size:500%">CPU detection</span></p>
            <br/>
            <br/>
            <br/>
-->
          </section>

          <section class="demo">

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
$ java -version
<span class="fragment">openjdk version "9-internal"
OpenJDK Runtime Environment (slowdebug build 9-internal+0-adhoc.simonis.jdk9-dev)
OpenJDK 64-Bit Server VM (slowdebug build 9-internal+0-adhoc.simonis.jdk9-dev, mixed mode)
$</span> <span class="fragment">gdb java</span>
<span class="fragment">GNU gdb (Ubuntu 7.7-0ubuntu3.1) 7.7
...
(gdb)</span> <span class="fragment">run -version</span>
<span class="fragment">Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff7fdb700 (LWP 6549)]
<mark>0x00007fffd8514513</mark> in ?? ()
(gdb)</span> <span class="fragment">where</span>
<span class="fragment">#0  <mark>0x00007fffd8514513</mark> in ?? ()  // gdb can't reliably find out where we are!
#1  0x0000000000000246 in ?? ()
#2  0x00007fffd85142a0 in ?? ()
#3  0x00007ffff0019000 in ?? ()
#4  0x00007ffff7fda400 in ?? ()
#5  0x00007ffff67068c3 in VM_Version::get_processor_features ()
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/cpu/x86/vm/vm_version_x86.cpp:477
Backtrace stopped: previous frame inner to this frame (corrupt stack?)</span>
              </code>
            </pre>
          </section>

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) call help()    // internal HotSpot helper functions
<span class="fragment">"Executing help"
basic
  pp(void* p)   - try to make sense of p
  pv(intptr_t p)- ((PrintableResourceObj*) p)-&gt;print()
  ps()          - print current thread stack
  pss()         - print all thread stacks
  pm(int pc)    - print Method* given compiled PC
  findm(intptr_t pc) - finds Method*
  find(intptr_t x)   - finds &amp; prints nmethod/stub/bytecode/oop based on pointer into it
  pns(void* sp, void* fp, void* pc)  - print native (i.e. mixed) stack trace. E.g.
                   pns($sp, $rbp, $pc) on Linux/amd64 and Solaris/amd64 or
                   pns($sp, $ebp, $pc) on Linux/x86 or
                   pns($sp, 0, $pc)    on Linux/ppc64 or
                   pns($sp + 0x7ff, 0, $pc) on Solaris/SPARC
                 - in gdb do 'set overload-resolution off' before calling pns()
                 - in dbx do 'frame 1' before calling pns()
misc.
  flush()       - flushes the log file
  events()      - dump events from ring buffers
compiler debugging
  debug()       - to set things up for compiler debugging
  ndebug()      - undo debug</span>
              </code>
            </pre>
          </section>

<!--
(gdb) call pns($sp, $rbp, $pc)
"Executing pns"
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)
v  ~BufferBlob::get_cpu_info_stub // we're in generated code..
-->

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) call nm($pc)  // print $pc as 'native (i.e. generated) method'
<span class="fragment">"Executing nm"
[CodeBlob (0x00007fffd849d210)]
Framesize: 0
BufferBlob (0x00007fffd849d210) used for get_cpu_info_stub
(gdb)</span><span class="fragment"> x /4i $pc</span>
<span class="fragment">=> <mark>0x7fffd8514513</mark>:	mov    (%rsi),%eax
   0x7fffd8514515:	lea    0x30(%rbp),%rsi
   0x7fffd8514519:	mov    $0x10000,%eax
   0x7fffd851451e:	and    0x4(%rsi),%eax
(gdb)</span><span class="fragment"> print $rsi</span>
<span class="fragment">$3 = 0      // reading from zero obviously results in a SIGSEGV
(gdb)</span><span class="fragment"> stepi // entering the HotSpot signal handler</span>
<span class="fragment">signalHandler (sig=0, info=0x800, uc=0x6f732e6567616d69) at os_linux.cpp:4219
4219	void signalHandler(int sig, siginfo_t* info, void* uc) {
(gdb)</span><span class="fragment"> step  // single step until we get here:</span>
<span class="fragment">JVM_handle_linux_signal (sig=11, info=..., ucVoid=..., abort_if_unrecognized=1)
    at os_linux_x86.cpp:274
274	                        int abort_if_unrecognized) {</span>
              </code>
            </pre>
          </section>

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) next // single step until we get here:
412	    if ((sig == SIGSEGV) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
(gdb) <span class="fragment">next
414	      stub = VM_Version::cpuinfo_cont_addr();
(gdb)</span><span class="fragment"> print /x stub
$5 = <mark>0x7fffd8514515</mark>
(gdb)</span><span class="fragment"> tbreak *stub
Temporary breakpoint 2 at <mark>0x7fffd8514515</mark>
(gdb)</span><span class="fragment"> cont
Continuing.
Temporary breakpoint 2, <mark>0x00007fffd8514515</mark> in ?? ()
(gdb)</span><span class="fragment"> where
#0  <mark>0x00007fffd8514515</mark> in ?? () // we're back just one instruction after the
#1  0x0000000000000246 in ?? () //                          previous SIGSEGV
#2  0x00007fffd85142a0 in ?? ()
#3  0x00007ffff0019000 in ?? ()
#4  0x00007ffff7fda400 in ?? ()
#5  0x00007ffff67068c3 in VM_Version::get_processor_features ()
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/cpu/x86/vm/vm_version_x86.cpp:477
Backtrace stopped: previous frame inner to this frame (corrupt stack?)</span>
              </code>
            </pre>
          </section>


          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) up // go up the stack until we reach VM_Version::get_processor_features ()
...
#5  0x00007ffff67068c3 in VM_Version::get_processor_features ()
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/cpu/x86/vm/vm_version_x86.cpp:477
477	  get_cpu_info_stub(&amp;_cpuid_info);
(gdb)<span class="fragment"> ptype get_cpu_info_stub
type = void (*)(void *)
(gdb)</span><span class="fragment"> list get_cpu_info_stub             // generated by generate_get_cpu_info()
Function "get_cpu_info_stub" not defined //                in vm_version_x86.cpp
(gdb)</span><span class="fragment"> list vm_version_x86.cpp:340,404
340  // Some OSs have a bug when upper 128/256bits of YMM/ZMM
341  // registers are not restored after a signal processing.
342  // Generate SEGV here (reference through NULL)
344  // and check upper YMM/ZMM bits after it.
398  __ xorl(rsi, rsi);                         // rsi = 0
399  VM_Version::set_cpuinfo_segv_addr(__ pc());// SEGV addr. for signal handler
400  // Generate SEGV
401  __ movl(rax, Address(rsi, 0));             // load from 0
403  VM_Version::set_cpuinfo_cont_addr(__ pc());// continuation for signal hand.
404  // Returns here after signal. Save xmm0 to check it later.</span>
              </code>
            </pre>
          </section>

          <section>

            <h2>CPU detection</h2>

            <ul>
              <li>HotSpot generates code for CPU detection (in <code>VM_Version_StubGenerator::generate_get_cpu_info()</code>)</li>
              <li>In the previous code it checks if the YMM/ZMM registers are preserved across signals</li>
              <li>It loads a known value into a YMM/ZMM register and generates a <code>SIGSEGV</code></li>
              <li>The signal handler ignores the <code>SIGSEGV</code> and continues at the next instruction</li>
              <li>Later, in <code>os_supports_avx_vectors()</code> it checks if the register values were preserved</li>
              <li>For other CPUs (e.g. ppc64), instructions are generated which may cause a <code>SIGILL</code></li>
              <li>This is also handled in the signal handler and the corresponding feature is disabled</li>
            </ul>
          </section>

          <section>

            <h2>CPU detection - Unified JVM Logging (<a href="http://openjdk.java.net/jeps/158">JEP 158</a>)</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
$ java -Xlog:os+cpu -version
<span class="fragment">[0.021s][info][os,cpu] Logical CPUs per core: 1
[0.021s][info][os,cpu] L1 data cache line size: 64
[0.021s][info][os,cpu] UseSSE=4  UseAVX=1  UseAES=1  MaxVectorSize=64
[0.021s][info][os,cpu] Allocation prefetching: PREFETCHNTA at distance 256, 3 lines of 64 bytes
[0.021s][info][os,cpu] PrefetchCopyIntervalInBytes 576
[0.021s][info][os,cpu] PrefetchScanIntervalInBytes 576
[0.021s][info][os,cpu] PrefetchFieldsAhead 1
[0.021s][info][os,cpu] ContendedPaddingWidth 128
[0.021s][info][os,cpu] CPU:total 4 (initial active 4) (4 cores per cpu, 1 threads per core) family 6 model 69 stepping 1, cmov, cx8, fxsr, mmx, sse, sse2, sse3, ssse3, sse4.1, sse4.2, popcnt, avx, aes, clmul, lzcnt, tsc, tscinvbit
[0.021s][info][os,cpu] CPU Model and flags from /proc/cpuinfo:
[0.021s][info][os,cpu] model name	: Intel(R) Core(TM) i5-4300U CPU @ 1.90GHz
[0.021s][info][os,cpu] flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx rdtscp lm constant_tsc rep_good nopl xtopology nonstop_tsc pni pclmulqdq ssse3 cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx rdrand hypervisor lahf_lm abm
openjdk version "9-internal"
OpenJDK Runtime Environment (slowdebug build 9-internal+0-adhoc.simonis.jdk9-dev)
OpenJDK 64-Bit Server VM (slowdebug build 9-internal+0-adhoc.simonis.jdk9-dev, mixed mode)</span>
              </code>
            </pre>
          </section>

          <section class="demo">

            <h2>Safefetch</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="">
(gdb) run -version
Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff7fdb700 (LWP 7885)]
0x00007fffd8514513 in ?? () // this SIGSEGV is from the CPU detection!
(gdb) <span class="fragment">cont
Continuing.
[New Thread 0x7fffd833d700 (LWP 7886)]
[New Thread 0x7fffd823c700 (LWP 7887)]
[New Thread 0x7fffd813b700 (LWP 7888)]
[New Thread 0x7fffcbfff700 (LWP 7889)]
[New Thread 0x7fffcbafa700 (LWP 7890)]
[New Thread 0x7fffcb9f9700 (LWP 7891)]
[New Thread 0x7fffcb8f8700 (LWP 7892)]
[New Thread 0x7fffcb7f7700 (LWP 7893)]
[New Thread 0x7fffcb6f6700 (LWP 7894)]
... // HotSpot creates at least 10 threads (GC, JIT, VM, Timer, etc..)
Program received signal SIGSEGV, Segmentation fault.
0x00007fffd8691a5c in ?? ()
</span>
              </code>
            </pre>
          </section>

          <section class="demo">

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) where
<span class="fragment">#0  0x00007fffd8691a5c in ?? ()   // &lt;- generate code
#1  0x00007ffff6432798 in SafeFetch32 (adr=0xabc0000000000abc, errValue=2748)
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/stubRoutines.hpp:464
#2  0x00007ffff65cf278 in <mark class="border">test_safefetch32</mark> () at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/stubRoutines.cpp:250
#3  0x00007ffff65cfe2d in StubRoutines::initialize2 ()
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/stubRoutines.cpp:371
#4  0x00007ffff65cfe96 in <mark class="border">stubRoutines_init2</mark> () at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/stubRoutines.cpp:380
#5  0x00007ffff603f9b1 in init_globals () at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/init.cpp:149
#6  0x00007ffff664b7ff in Threads::create_vm (args=0x7ffff7fdae20, canTryAgain=0x7ffff7fdad0b)
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/runtime/thread.cpp:3625
#7  0x00007ffff60cea48 in JNI_CreateJavaVM_inner (vm=0x7ffff7fdae88, penv=0x7ffff7fdae90, args=0x7ffff7fdae20)
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/prims/jni.cpp:3974
#8  0x00007ffff60cedf0 in <mark class="border">JNI_CreateJavaVM</mark> (vm=0x7ffff7fdae88, penv=0x7ffff7fdae90, args=0x7ffff7fdae20)
    at /share/OpenJDK/jdk9-hs-comp/hotspot/src/share/vm/prims/jni.cpp:4069
#9  0x00007ffff7bcd358 in InitializeJVM (pvm=0x7ffff7fdae88, penv=0x7ffff7fdae90, ifn=0x7ffff7fdaee0)
    at /share/OpenJDK/jdk9-hs-comp/jdk/src/java.base/share/native/libjli/java.c:1489
#10 0x00007ffff7bca171 in <mark class="border">JavaMain</mark> (_args=0x7fffffffaa70)
    at /share/OpenJDK/jdk9-hs-comp/jdk/src/java.base/share/native/libjli/java.c:403
#11 0x00007ffff71cd182 in start_thread (arg=0x7ffff7fdb700) at pthread_create.c:312</span>
             </code>
            </pre>
          </section>

          <section class="demo">

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) call pns($sp, $rbp, $pc)
<span class="fragment">"Executing pns"
Native frames: (J=compiled Java code, A=aot compiled Java code, j=interpreted,
                Vv=VM code, C=native code)
v  ~StubRoutines::SafeFetch32
V  [libjvm.so+0x11c60e7]  <mark class="border">test_safefetch32()</mark>+0x4d
V  [libjvm.so+0x11c6c9b]  StubRoutines::initialize2()+0x9a3
V  [libjvm.so+0x11c6d04]  <mark class="border">stubRoutines_init2()</mark>+0x1c
V  [libjvm.so+0xc29d35]  init_globals()+0xe2
V  [libjvm.so+0x1241fed]  Threads::create_vm(JavaVMInitArgs*, bool*)+0x3e3
V  [libjvm.so+0xcb92a8]  JNI_CreateJavaVM_inner(JavaVM_**, void**, void*)+0xf6
V  [libjvm.so+0xcb9650]  <mark class="border">JNI_CreateJavaVM</mark>+0x42
C  [libjli.so+0x72d3]  InitializeJVM+0x13b
C  [libjli.so+0x400b]  <mark class="border">JavaMain</mark>+0xd3
C  [libpthread.so.0+0x8182]  start_thread+0xc2
(gdb)</span> <span class="fragment">call find($pc)</span>
<span class="fragment"><mark class="orange">0x00007fffd8691a5c</mark> is at begin+0 in a stub // this is generated code again :)
StubRoutines::SafeFetch32 [0x00007fffd8691a5c, 0x00007fffd8691a62[ (6 bytes)</span>
             </code>
            </pre>
          </section>

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
(gdb) x /3i $pc         // %rdi = arg1, %rsi = arg2, %rax = return value
<span class="fragment">=&gt; <mark class="orange">0x7fffd8691a5c</mark>:	mov    (%rdi),%rsi // *arg1 -&gt; arg2
   <mark>0x7fffd8691a5e</mark>:	mov    %rsi,%rax   //  arg2 -&gt; return value
   0x7fffd8691a61:	retq
(gdb) </span><span class="fragment">p /x $rdi
$1 = 0xabc0000000000abc
(gdb) </span><span class="fragment">x /1g 0xabc0000000000abc
0xabc0000000000abc:	Cannot access memory at address 0xabc0000000000abc
(gdb) </span><span class="fragment">stepi // and next/step until we reach in JVM_handle_linux_signal() at:
332   if (StubRoutines::is_safefetch_fault(pc)) {
333     ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
(gdb) </span><span class="fragment">step
StubRoutines::continuation_for_safefetch_fault (pc=<mark class="orange">0x7fffd8691a5c</mark>)
(gdb) </span><span class="fragment">finish
Run till exit from #0  StubRoutines::continuation_for_safefetch_fault (...)
Value returned is $9 = (u_char *) <mark>0x7fffd8691a5e</mark>  // Continuation address
(gdb) </span><span class="fragment">finish // three times until we're back in our stub
Run till exit from #0  JVM_handle_linux_signal (...)
Run till exit from #0  signalHandler (...)
<mark>0x00007fffd8691a5e</mark> in ?? ()</span>
              </code>
            </pre>
          </section>

          <section>

            <h2>SafeFetch</h2>

            <pre class="big noshadow" data-trim="true">
              <code class="cpp" text-trim="true" data-noescape="true">
<![CDATA[
// Safefetch allows to load a value from a location that's not known
// to be valid. If the load causes a fault, the error value is returned.
inline int SafeFetch32(int* adr, int errValue) {
  assert(StubRoutines::SafeFetch32_stub(), "stub not yet generated");
  return StubRoutines::SafeFetch32_stub()(adr, errValue);
}
]]>
              </code>
            </pre>

            <ul>
              <li>Sometimes the has to read values from unreliable addresses</li>
              <li>HotSpot generates so called <code>SafeFetch</code> stubs for this purpose</li>
              <li>They read and return the value stored at <code>addr</code> if possible</li>
              <li>If that results in a <code>SIGSEGV</code>, <code>errValue</code> will be returned</li>
              <li>The signal handler ignores the potential <code>SIGSEGV</code></li>
            </ul>
          </section>
<!--
    __ xorl(rsi, rsi);
    VM_Version::set_cpuinfo_segv_addr(__ pc());
    // Generate SEGV
    __ movl(rax, Address(rsi, 0));

    VM_Version::set_cpuinfo_cont_addr(__ pc());
    // Returns here after signal. Save xmm0 to check it later.


          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
              </code>
            </pre>
          </section>
-->
        </section>

        <section>

          <section>

            <h2>Null-Pointer Checks - C/C++</h2>

            <pre class="big noshadow" data-trim="true">
              <code class="cpp" data-trim="true" data-noescape="true">
struct NullCheck {
  long l0001;
};

void swapFields(NullCheck* n1, NullCheck* n2) {
  long tmp  = n1->l0001;
  n1->l0001 = n2->l0001;
  n2->l0001 = tmp;
}

int main(int argc, char** argv) {
  <mark class="border">NullCheck* n = (NullCheck*)0</mark>;
  swapFields(n, n);
}
              </code>
            </pre>
          </section>

          <section>

            <h2>Null-Pointer Checks - C/C++</h2>

            <p>Unmanaged languages (e.g. C/C++) don't have Null-Pointer checks:</p>

            <pre class="big noshadow" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true">
$ g++ -O3 -o NullCheck NullCheck.cpp
<span class="fragment">$ ./NullCheck</span>
<span class="fragment">Segmentation fault (core dumped)</span>
<span class="fragment">$ objdump --disassemble --demangle NullCheck</span>
<span class="fragment">...
0000000000400500 &lt;swapFields(NullCheck* n1, NullCheck* n2)>:
  400500: 48 8b 07 mov    (%rdi),%rax // %rax = n1->l0001
  400503: 48 8b 16 mov    (%rsi),%rdx // %rdx = n2->l0001
  400506: 48 89 17 mov    %rdx,(%rdi) // n1->l0001 = %rdx (n2->l0001)
  400509: 48 89 06 mov    %rax,(%rsi) // n2->l0001 = %rax (n1->l0001)
  40050c: c3       retq</span>
              </code>
            </pre>
          </section>

        </section>


        <section style="height: 100%;">

          <section>

            <h2>Null-Pointer Checks - HotSpot</h2>

            <p>Managed languages like Java guarantee Null-Pointer checks!</p>

            <pre class="big noshadow" style="height: 70%;" data-trim="true">
              <code class="java" text-trim="true" data-noescape="true">
<![CDATA[
public class NullCheck {
  long l0000, l0001, l0002, l0003, l0004, l0005, l0006, l0007, l0008, l0009;
  //...
  long l0510, l0511, l0512, l0513, l0514, l0515, l0516, l0517, l0518, l0519;

  void swapField_1(NullCheck n1, NullCheck n2) {
    long tmp = n1.l0001;
    n1.l0001 = n2.l0001;
    n2.l0001 = tmp;
  }
  void swapField_2(NullCheck n1, NullCheck n2) {
    long tmp = n1.l0512;
    n1.l0512 = n2.l0512;
    n2.l0512 = tmp;
  }
]]>
              </code>
            </pre>
          </section>

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ java -XX:-TieredCompilation -Xbatch \
       -XX:CompileCommand="option *::swapField_2 PrintAssembly" \
        org.simonis.NullCheck swapField_2
<span class="fragment" data-fragment-index="1">...
Compiled method (c2) org.simonis.NullCheck::swapField_2 (19 bytes)
  # parm0:    rsi:rsi   = 'org/simonis/NullCheck'
  # parm1:    rdx:rdx   = 'org/simonis/NullCheck'

0x07fc7348e0e4c: <span class="fragment highlight-border" data-fragment-index="2">test %rsi,%rsi</span>         // null-check first arg 'n1'
0x07fc7348e0e4f: je   0x07fc7348e0e7e
0x07fc7348e0e51: <span class="fragment highlight-border" data-fragment-index="2">test %rdx,%rdx</span>         // null-check second arg 'n2'
0x07fc7348e0e54: je   0x07fc7348e0e8d
0x07fc7348e0e56: mov  0x1010(%rdx),%r10 //*getfield l0512
                                        // - NullCheck::swapField_2@7 (line 13)
0x07fc7348e0e5d: mov  0x1010(%rsi),%r11 //*getfield l0512
                                        // - NullCheck::swapField_2@1 (line 12)
0x07fc7348e0e64: mov  %r10,0x1010(%rsi) //*putfield l0512
                                        // - NullCheck::swapField_2@10 (line 13)
0x07fc7348e0e6b: mov  %r11,0x1010(%rdx) //*putfield l0512
                                        // - NullCheck::swapField_2@15 (line 14)</span>
              </code>
            </pre>
          </section>

          <section class="demo">
            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ java -XX:-TieredCompilation -Xbatch \
       -XX:CompileCommand="option *::swapField_1 PrintAssembly" \
        org.simonis.NullCheck swapField_1
<span class="fragment">...
Compiled method (c2) org.simonis.NullCheck::swapField_1 (19 bytes)
  # parm0:    rsi:rsi   = 'org/simonis/NullCheck'
  # parm1:    rdx:rdx   = 'org/simonis/NullCheck'





0x07f9f0c8e104c: mov    0x18(%rsi),%r10 //*getfield l0001
                                        // - NullCheck::swapField_1@1 (line 6)
0x07f9f0c8e1050: mov    0x18(%rdx),%r11 //*getfield l0001
                                        // - NullCheck::swapField_1@3 (line 7)
0x07f9f0c8e1054: mov    %r11,0x18(%rsi) //*putfield l0001
                                        // - NullCheck::swapField_1@10 (line 7) 
0x07f9f0c8e1058: mov    %r10,0x18(%rdx) //*putfield l0001
                                        // - NullCheck::swapField_1@15 (line 8)</span>
              </code>
            </pre>
          </section>

          <section>

            <h2>Null-Pointer Checks</h2>
            <br/>
            <br/>
            <p><span style="font-size:800%">DEMO</span></p>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>

          </section>

          <section>

            <pre class="big noshadow" style="height: 100%; margin: 0;" data-trim="true">
              <code class="java" data-trim="true" data-noescape="true" style="height:100%;">
public static void main(String[] args) {

  if ("swapField_1".equals(args[0])) {

    prompt("Calling swapField_1() to JIT-compile it:");

    for (int i = 0; i &lt; 20_000; i++) {
      <span class="fragment highlight-border">swapField_1(n, n);</span>
    }
    for (int i = 1; i &lt;= 5; i++) {
      prompt(i + ": calling swapField_1() with a NULL argument:");
      try {
        <span class="fragment highlight-border">swapField_1(null, n);</span>
      } catch (NullPointerException npe) { npe.printStackTrace(System.out); }
    }
    prompt("Calling swapField_1() to JIT-compile it again:");
    for (int i = 0; i &lt; 20_000; i++) {
      <span class="fragment highlight-border">swapField_1(n, n);</span>
    }
  }
              </code>
            </pre>
          </section>

          <section>

            <h2>Null-Pointer Checks - Summary</h2>

            <ul>
              <li>Null-pointer checks are done <em>implicitly</em> (if possible):
                <ul>
                  <li>Not on all platforms (i.e. AIX can read from <code>0x0000</code>)</li>
                  <li>Not all field offsets (usually within <code>`getconf PAGESIZE`</code>)</li>
                </ul>
              </li>
              <li>If there are too many NPE (see <code>-XX:PerBytecodeTrapLimit</code>)
                <ul>
                  <li>Methods are made <em>not-entrant</em> and..</li>
                  <li>..recompiled with <em>explicit</em> checks instead</li>
                </ul>
              </li>
              <li>Work together with Compressed Oops</li>
            </ul>
          </section>

          <section>

            <p><span style="font-size:600%">But where's the benchmark?</span></p>
            <br/>
            <p><a href="https://github.com/shipilev/article-compress-me/blob/master/src/main/java/net/shipilev/ImplicitNullChecks.java">
            https://github.com/shipilev/article-compress-me/blob/master/src/main/java/net/shipilev/ImplicitNullChecks.java</a></p>
            <br/>

          </section>
<!--
https://github.com/shipilev/article-compress-me/blob/master/src/main/java/net/shipilev/ImplicitNullChecks.java
-->
        </section>



<!--
-XX:+PrintGCDetails -XX:+PrintSafepointStatistics -XX:PrintSafepointStatisticsCount=1
SafepointTimeout
ShowSafepointMsgs
-XX:+UseCountedLoopSafepoints
-->


        <section>

          <section>
            <h2>Safepoints</h2>

            <blockquote>
              <p style="text-align:justify">
                &ldquo; A point during program execution at which all GC roots are known<br/> and all heap object contents are consistent. &rdquo;
              </p>
              <footer>
                <cite><a href="http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html">HotSpot Glossary of Terms</a></cite>
              </footer>
            </blockquote>

            <ul>
              <li>HotSpot uses a <em>cooperative</em> suspension model</li>
              <li>All threads need to come to a safepoint quickly if required
                <ul>
                  <li>Running interpreted: change interpreter dispatch table</li>
                  <li>Running JIT-compiled: read global safepoint polling page</li>
                  <li>Running in native (JNI): no need to stop<br/>
                    - native code accesses oops trough handles<br/>
                    - block when returning from JNI or when calling to Java</li>
                </ul>
              </li>
            </ul>
          </section>

          <section>
            <h2>Safepoints</h2>

            <div width="100%" style="position: relative; margin: 0 0 0 0px;">
              <div class="" style="position: static;">
                <object data="images/adjusted/SafePoint_1.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_2.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_3.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_4.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_5.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_6.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_7.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_8.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_9.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_10.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_11.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_12.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_13.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_14.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_15.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_16.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/adjusted/SafePoint_17.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
            </div>
          </section>

          <section>

            <h2>Safepoints</h2>
            <br/>
            <br/>
            <p><span style="font-size:800%">DEMO</span></p>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>
            <br/>

          </section>

        </section>

        <section>

          <h3 style="text-transform: none;"><a href="https://github.com/simonis/hotspot_internals">https://github.com/simonis/hotspot_internals</a></h3>

          <h3 style="text-transform: none;"><a href="https://rawgit.com/simonis/hotspot_internals/master/hotspot_internals.xhtml#/">https://rawgit.com/simonis/hotspot_internals/master/hotspot_internals.xhtml</a></h3>

        </section>

      </div>

    </div>

    <script src="reveal.js/lib/js/head.min.js"></script>
    <script src="reveal.js/js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        //width: 1024,
        //height: 768,
        //width: 1280,
        //height: 720,
        width: 1366,
        height: 768,
        //width: 1920,
        //height: 1080,
        margin: 0.1,
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'none', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'reveal.js/plugin/highlight/highlight_9.7.0.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() {

hljs.registerLanguage('terminal', function(hljs) {
  return {
    contains: [
      hljs.C_LINE_COMMENT_MODE,
      {
        className: 'title',
        lexemes: /[$()>_a-zA-Z0-9]+/,
        keywords: "$ (gdb)",
        begin: /^\$ |\(gdb\)/,
        end: /[^\\]\n/,
	contains: [
          hljs.COMMENT('//', '$', { endsParent: true })
	]
      }
    ]
  }
});

hljs.initHighlightingOnLoad(); } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>

<!--  LocalWords:  HotSpot scrollable px pre noshadow Volker Simonis builtin VM
 -->
<!--  LocalWords:  Observability Bytecode runtime bytecodes Ljava sayHello ns
 -->
<!--  LocalWords:  JBreak JVMTI JNI fPIC JDK traceMethodAgent cpp TTS Safepoint
 -->
<!--  LocalWords:  unboxing JIT JVM safepoints Intrinsify fff POSIX
 -->
<!--  LocalWords:  NullPointers StackOverflows SEH VEH AIX NPE GC
 -->
<!--  LocalWords:  safepoint
 -->
